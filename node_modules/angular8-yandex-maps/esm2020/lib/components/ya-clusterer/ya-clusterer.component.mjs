import { ChangeDetectionStrategy, Component, ContentChildren, EventEmitter, Input, Output, } from '@angular/core';
import { Subscription } from 'rxjs';
import { YaGeoObjectDirective } from '../ya-geoobject/ya-geoobject.directive';
import { YaPlacemarkDirective } from '../ya-placemark/ya-placemark.directive';
import { EventManager } from '../../event-manager';
import * as i0 from "@angular/core";
import * as i1 from "../ya-map/ya-map.component";
/**
 * The `ya-clusterer` component wraps `ymaps.Clusterer` class from the Yandex.Maps API.
 * You can configure it via the component's inputs.
 * Events can be bound using the outputs of the component.
 *
 * <example-url>https://stackblitz.com/edit/placemark-clusterer?embed=1</example-url>
 *
 * @example
 * ```html
 * <ya-map [center]="[55.761952, 37.620739]">
 *   <ya-clusterer [options]="{ minClusterSize: 5 }">
 *     <ya-placemark [geometry]="[55.74, 37.5]"></ya-placemark>
 *     <ya-placemark [geometry]="[55.64, 37.46]"></ya-placemark>
 *     <ya-placemark [geometry]="[55.75, 37.38]"></ya-placemark>
 *
 *     <ya-geoobject
 *       [feature]="{ geometry: { type: 'Point', coordinates: [55.81, 37.4] } }"
 *      ></ya-geoobject>
 *
 *     <ya-geoobject
 *       [feature]="{ geometry: { type: 'Point', coordinates: [55.7, 37.39] } }"
 *      ></ya-geoobject>
 *   </ya-clusterer>
 * </ya-map>
 * ```
 */
export class YaClustererComponent {
    constructor(_ngZone, _yaMapComponent) {
        this._ngZone = _ngZone;
        this._yaMapComponent = _yaMapComponent;
        this._sub = new Subscription();
        this._eventManager = new EventManager(this._ngZone);
        /**
         * Clusterer instance is added in a Map.
         */
        this.ready = new EventEmitter();
        /**
         * Closing the hint.
         */
        this.hintclose = this._eventManager.getLazyEmitter('hintclose');
        /**
         * Opening a hint on a map.
         */
        this.hintopen = this._eventManager.getLazyEmitter('hintopen');
        /**
         * Map reference changed.
         */
        this.mapchange = this._eventManager.getLazyEmitter('mapchange');
        /**
         * Change to the object options.
         */
        this.optionschange = this._eventManager.getLazyEmitter('optionschange');
        /**
         * The parent object reference changed.
         */
        this.parentchange = this._eventManager.getLazyEmitter('parentchange');
    }
    /**
     * Handles input changes and passes them in API.
     * @param changes
     */
    ngOnChanges(changes) {
        const clusterer = this._clusterer;
        if (clusterer) {
            const { options } = changes;
            if (options) {
                clusterer.options.set(options.currentValue);
            }
        }
    }
    ngAfterContentInit() {
        if (this._yaMapComponent.isBrowser) {
            const sub = this._yaMapComponent.map$.subscribe((map) => {
                if (map) {
                    const clusterer = this._createClusterer();
                    this._clusterer = clusterer;
                    map.geoObjects.add(clusterer);
                    this._eventManager.setTarget(clusterer);
                    this._watchForContentChanges(clusterer);
                    this._ngZone.run(() => this.ready.emit({ ymaps, target: clusterer }));
                }
            });
            this._sub.add(sub);
        }
    }
    ngOnDestroy() {
        this._eventManager.destroy();
        this._sub.unsubscribe();
    }
    /**
     * Creates Clusterer.
     */
    _createClusterer() {
        return new ymaps.Clusterer(this.options);
    }
    _watchForContentChanges(clusterer) {
        /**
         * Adds new Placemarks to the clusterer on changes.
         */
        const currentPlacemarks = new Set();
        this._getInternalPlacemarks(this._placemarks.toArray()).forEach((placemark) => {
            currentPlacemarks.add(placemark);
            clusterer.add(placemark);
        });
        const placemarksSub = this._placemarks.changes.subscribe((placemarkDirectives) => {
            const newPlacemarks = new Set(this._getInternalPlacemarks(placemarkDirectives));
            const difference = this._getDifference(newPlacemarks, currentPlacemarks);
            clusterer.add(difference.toAdd);
            clusterer.remove(difference.toRemove);
        });
        this._sub.add(placemarksSub);
        /**
         * Adds new GeoObjects to the clusterer on changes.
         */
        const currentGeoObjects = new Set();
        this._getInternalGeoObjects(this._geoObjects.toArray()).forEach((geoObject) => {
            currentGeoObjects.add(geoObject);
            clusterer.add(geoObject);
        });
        const geoObjectsSub = this._geoObjects.changes.subscribe((geoObjectDirectives) => {
            const newGeoObjects = new Set(this._getInternalGeoObjects(geoObjectDirectives));
            const difference = this._getDifference(newGeoObjects, currentGeoObjects);
            clusterer.add(difference.toAdd);
            clusterer.remove(difference.toRemove);
        });
        this._sub.add(geoObjectsSub);
    }
    /**
     * Determines what should be added/removed in current set to equal new set
     *
     * @param newSet
     * @param currentSet
     */
    _getDifference(newSet, currentSet) {
        const toAdd = [];
        const toRemove = [];
        newSet.forEach((component) => {
            if (!currentSet.has(component)) {
                toAdd.push(component);
                currentSet.add(component);
            }
        });
        currentSet.forEach((component) => {
            if (!newSet.has(component)) {
                toRemove.push(component);
                currentSet.delete(component);
            }
        });
        return {
            toAdd,
            toRemove,
        };
    }
    _getInternalPlacemarks(placemarks) {
        return placemarks
            .filter((component) => !!component.placemark)
            .map((component) => component.placemark);
    }
    _getInternalGeoObjects(geoObjects) {
        return geoObjects
            .filter((component) => !!component.geoObject)
            .map((component) => component.geoObject);
    }
}
YaClustererComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.0.2", ngImport: i0, type: YaClustererComponent, deps: [{ token: i0.NgZone }, { token: i1.YaMapComponent }], target: i0.ɵɵFactoryTarget.Component });
YaClustererComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "12.0.0", version: "13.0.2", type: YaClustererComponent, selector: "ya-clusterer", inputs: { options: "options" }, outputs: { ready: "ready", hintclose: "hintclose", hintopen: "hintopen", mapchange: "mapchange", optionschange: "optionschange", parentchange: "parentchange" }, queries: [{ propertyName: "_placemarks", predicate: YaPlacemarkDirective }, { propertyName: "_geoObjects", predicate: YaGeoObjectDirective }], usesOnChanges: true, ngImport: i0, template: '<ng-content></ng-content>', isInline: true, changeDetection: i0.ChangeDetectionStrategy.OnPush });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.0.2", ngImport: i0, type: YaClustererComponent, decorators: [{
            type: Component,
            args: [{
                    selector: 'ya-clusterer',
                    template: '<ng-content></ng-content>',
                    changeDetection: ChangeDetectionStrategy.OnPush,
                }]
        }], ctorParameters: function () { return [{ type: i0.NgZone }, { type: i1.YaMapComponent }]; }, propDecorators: { _placemarks: [{
                type: ContentChildren,
                args: [YaPlacemarkDirective]
            }], _geoObjects: [{
                type: ContentChildren,
                args: [YaGeoObjectDirective]
            }], options: [{
                type: Input
            }], ready: [{
                type: Output
            }], hintclose: [{
                type: Output
            }], hintopen: [{
                type: Output
            }], mapchange: [{
                type: Output
            }], optionschange: [{
                type: Output
            }], parentchange: [{
                type: Output
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoieWEtY2x1c3RlcmVyLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL2FuZ3VsYXI4LXlhbmRleC1tYXBzL3NyYy9saWIvY29tcG9uZW50cy95YS1jbHVzdGVyZXIveWEtY2x1c3RlcmVyLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBRUwsdUJBQXVCLEVBQ3ZCLFNBQVMsRUFDVCxlQUFlLEVBQ2YsWUFBWSxFQUNaLEtBQUssRUFJTCxNQUFNLEdBR1AsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFjLFlBQVksRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNoRCxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSx3Q0FBd0MsQ0FBQztBQUU5RSxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSx3Q0FBd0MsQ0FBQztBQUM5RSxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0scUJBQXFCLENBQUM7OztBQUluRDs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQXlCRztBQU1ILE1BQU0sT0FBTyxvQkFBb0I7SUF3RC9CLFlBQTZCLE9BQWUsRUFBbUIsZUFBK0I7UUFBakUsWUFBTyxHQUFQLE9BQU8sQ0FBUTtRQUFtQixvQkFBZSxHQUFmLGVBQWUsQ0FBZ0I7UUFqRDdFLFNBQUksR0FBRyxJQUFJLFlBQVksRUFBRSxDQUFDO1FBRTFCLGtCQUFhLEdBQUcsSUFBSSxZQUFZLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBVWhFOztXQUVHO1FBQ08sVUFBSyxHQUFnRCxJQUFJLFlBQVksRUFFNUUsQ0FBQztRQUVKOztXQUVHO1FBQ08sY0FBUyxHQUNqQixJQUFJLENBQUMsYUFBYSxDQUFDLGNBQWMsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUVqRDs7V0FFRztRQUNPLGFBQVEsR0FDaEIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxjQUFjLENBQUMsVUFBVSxDQUFDLENBQUM7UUFFaEQ7O1dBRUc7UUFDTyxjQUFTLEdBQ2pCLElBQUksQ0FBQyxhQUFhLENBQUMsY0FBYyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBRWpEOztXQUVHO1FBQ08sa0JBQWEsR0FDckIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxjQUFjLENBQUMsZUFBZSxDQUFDLENBQUM7UUFFckQ7O1dBRUc7UUFDTyxpQkFBWSxHQUNwQixJQUFJLENBQUMsYUFBYSxDQUFDLGNBQWMsQ0FBQyxjQUFjLENBQUMsQ0FBQztJQUU2QyxDQUFDO0lBRWxHOzs7T0FHRztJQUNILFdBQVcsQ0FBQyxPQUFzQjtRQUNoQyxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDO1FBRWxDLElBQUksU0FBUyxFQUFFO1lBQ2IsTUFBTSxFQUFFLE9BQU8sRUFBRSxHQUFHLE9BQU8sQ0FBQztZQUU1QixJQUFJLE9BQU8sRUFBRTtnQkFDWCxTQUFTLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUM7YUFDN0M7U0FDRjtJQUNILENBQUM7SUFFRCxrQkFBa0I7UUFDaEIsSUFBSSxJQUFJLENBQUMsZUFBZSxDQUFDLFNBQVMsRUFBRTtZQUNsQyxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRTtnQkFDdEQsSUFBSSxHQUFHLEVBQUU7b0JBQ1AsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7b0JBQzFDLElBQUksQ0FBQyxVQUFVLEdBQUcsU0FBUyxDQUFDO29CQUU1QixHQUFHLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQztvQkFDOUIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFDLENBQUM7b0JBQ3hDLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxTQUFTLENBQUMsQ0FBQztvQkFDeEMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxDQUFDLENBQUMsQ0FBQztpQkFDdkU7WUFDSCxDQUFDLENBQUMsQ0FBQztZQUVILElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQ3BCO0lBQ0gsQ0FBQztJQUVELFdBQVc7UUFDVCxJQUFJLENBQUMsYUFBYSxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQzdCLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDMUIsQ0FBQztJQUVEOztPQUVHO0lBQ0ssZ0JBQWdCO1FBQ3RCLE9BQU8sSUFBSSxLQUFLLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUMzQyxDQUFDO0lBRU8sdUJBQXVCLENBQUMsU0FBMEI7UUFDeEQ7O1dBRUc7UUFDSCxNQUFNLGlCQUFpQixHQUFHLElBQUksR0FBRyxFQUFtQixDQUFDO1FBRXJELElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsU0FBUyxFQUFFLEVBQUU7WUFDNUUsaUJBQWlCLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQ2pDLFNBQVMsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDM0IsQ0FBQyxDQUFDLENBQUM7UUFFSCxNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQ3RELENBQUMsbUJBQTJDLEVBQUUsRUFBRTtZQUM5QyxNQUFNLGFBQWEsR0FBRyxJQUFJLEdBQUcsQ0FDM0IsSUFBSSxDQUFDLHNCQUFzQixDQUFDLG1CQUFtQixDQUFDLENBQ2pELENBQUM7WUFFRixNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFrQixhQUFhLEVBQUUsaUJBQWlCLENBQUMsQ0FBQztZQUUxRixTQUFTLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUNoQyxTQUFTLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUN4QyxDQUFDLENBQ0YsQ0FBQztRQUVGLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBRTdCOztXQUVHO1FBQ0gsTUFBTSxpQkFBaUIsR0FBRyxJQUFJLEdBQUcsRUFBbUIsQ0FBQztRQUVyRCxJQUFJLENBQUMsc0JBQXNCLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLFNBQVMsRUFBRSxFQUFFO1lBQzVFLGlCQUFpQixDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUNqQyxTQUFTLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQzNCLENBQUMsQ0FBQyxDQUFDO1FBRUgsTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUN0RCxDQUFDLG1CQUEyQyxFQUFFLEVBQUU7WUFDOUMsTUFBTSxhQUFhLEdBQUcsSUFBSSxHQUFHLENBQzNCLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxtQkFBbUIsQ0FBQyxDQUNqRCxDQUFDO1lBRUYsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBa0IsYUFBYSxFQUFFLGlCQUFpQixDQUFDLENBQUM7WUFFMUYsU0FBUyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDaEMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDeEMsQ0FBQyxDQUNGLENBQUM7UUFFRixJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsQ0FBQztJQUMvQixDQUFDO0lBRUQ7Ozs7O09BS0c7SUFDSyxjQUFjLENBQUksTUFBYyxFQUFFLFVBQWtCO1FBQzFELE1BQU0sS0FBSyxHQUFRLEVBQUUsQ0FBQztRQUN0QixNQUFNLFFBQVEsR0FBUSxFQUFFLENBQUM7UUFFekIsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLFNBQVMsRUFBRSxFQUFFO1lBQzNCLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxFQUFFO2dCQUM5QixLQUFLLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO2dCQUN0QixVQUFVLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDO2FBQzNCO1FBQ0gsQ0FBQyxDQUFDLENBQUM7UUFFSCxVQUFVLENBQUMsT0FBTyxDQUFDLENBQUMsU0FBUyxFQUFFLEVBQUU7WUFDL0IsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLEVBQUU7Z0JBQzFCLFFBQVEsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7Z0JBQ3pCLFVBQVUsQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUM7YUFDOUI7UUFDSCxDQUFDLENBQUMsQ0FBQztRQUVILE9BQU87WUFDTCxLQUFLO1lBQ0wsUUFBUTtTQUNULENBQUM7SUFDSixDQUFDO0lBRU8sc0JBQXNCLENBQUMsVUFBa0M7UUFDL0QsT0FBTyxVQUFVO2FBQ2QsTUFBTSxDQUFDLENBQUMsU0FBUyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQzthQUM1QyxHQUFHLENBQUMsQ0FBQyxTQUFTLEVBQUUsRUFBRSxDQUFDLFNBQVMsQ0FBQyxTQUFVLENBQUMsQ0FBQztJQUM5QyxDQUFDO0lBRU8sc0JBQXNCLENBQUMsVUFBa0M7UUFDL0QsT0FBTyxVQUFVO2FBQ2QsTUFBTSxDQUFDLENBQUMsU0FBUyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQzthQUM1QyxHQUFHLENBQUMsQ0FBQyxTQUFTLEVBQUUsRUFBRSxDQUFDLFNBQVMsQ0FBQyxTQUFVLENBQUMsQ0FBQztJQUM5QyxDQUFDOztpSEFwTVUsb0JBQW9CO3FHQUFwQixvQkFBb0IsaVJBQ2Qsb0JBQW9CLDhDQUdwQixvQkFBb0Isa0RBUDNCLDJCQUEyQjsyRkFHMUIsb0JBQW9CO2tCQUxoQyxTQUFTO21CQUFDO29CQUNULFFBQVEsRUFBRSxjQUFjO29CQUN4QixRQUFRLEVBQUUsMkJBQTJCO29CQUNyQyxlQUFlLEVBQUUsdUJBQXVCLENBQUMsTUFBTTtpQkFDaEQ7MEhBR2tCLFdBQVc7c0JBRDNCLGVBQWU7dUJBQUMsb0JBQW9CO2dCQUlwQixXQUFXO3NCQUQzQixlQUFlO3VCQUFDLG9CQUFvQjtnQkFhNUIsT0FBTztzQkFBZixLQUFLO2dCQUtJLEtBQUs7c0JBQWQsTUFBTTtnQkFPRyxTQUFTO3NCQUFsQixNQUFNO2dCQU1HLFFBQVE7c0JBQWpCLE1BQU07Z0JBTUcsU0FBUztzQkFBbEIsTUFBTTtnQkFNRyxhQUFhO3NCQUF0QixNQUFNO2dCQU1HLFlBQVk7c0JBQXJCLE1BQU0iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBBZnRlckNvbnRlbnRJbml0LFxuICBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneSxcbiAgQ29tcG9uZW50LFxuICBDb250ZW50Q2hpbGRyZW4sXG4gIEV2ZW50RW1pdHRlcixcbiAgSW5wdXQsXG4gIE5nWm9uZSxcbiAgT25DaGFuZ2VzLFxuICBPbkRlc3Ryb3ksXG4gIE91dHB1dCxcbiAgUXVlcnlMaXN0LFxuICBTaW1wbGVDaGFuZ2VzLFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE9ic2VydmFibGUsIFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgWWFHZW9PYmplY3REaXJlY3RpdmUgfSBmcm9tICcuLi95YS1nZW9vYmplY3QveWEtZ2Vvb2JqZWN0LmRpcmVjdGl2ZSc7XG5pbXBvcnQgeyBZYU1hcENvbXBvbmVudCB9IGZyb20gJy4uL3lhLW1hcC95YS1tYXAuY29tcG9uZW50JztcbmltcG9ydCB7IFlhUGxhY2VtYXJrRGlyZWN0aXZlIH0gZnJvbSAnLi4veWEtcGxhY2VtYXJrL3lhLXBsYWNlbWFyay5kaXJlY3RpdmUnO1xuaW1wb3J0IHsgRXZlbnRNYW5hZ2VyIH0gZnJvbSAnLi4vLi4vZXZlbnQtbWFuYWdlcic7XG5pbXBvcnQgeyBZYVJlYWR5RXZlbnQgfSBmcm9tICcuLi8uLi90eXBpbmdzL3lhLXJlYWR5LWV2ZW50JztcbmltcG9ydCB7IFlhRXZlbnQgfSBmcm9tICcuLi8uLi90eXBpbmdzL3lhLWV2ZW50JztcblxuLyoqXG4gKiBUaGUgYHlhLWNsdXN0ZXJlcmAgY29tcG9uZW50IHdyYXBzIGB5bWFwcy5DbHVzdGVyZXJgIGNsYXNzIGZyb20gdGhlIFlhbmRleC5NYXBzIEFQSS5cbiAqIFlvdSBjYW4gY29uZmlndXJlIGl0IHZpYSB0aGUgY29tcG9uZW50J3MgaW5wdXRzLlxuICogRXZlbnRzIGNhbiBiZSBib3VuZCB1c2luZyB0aGUgb3V0cHV0cyBvZiB0aGUgY29tcG9uZW50LlxuICpcbiAqIDxleGFtcGxlLXVybD5odHRwczovL3N0YWNrYmxpdHouY29tL2VkaXQvcGxhY2VtYXJrLWNsdXN0ZXJlcj9lbWJlZD0xPC9leGFtcGxlLXVybD5cbiAqXG4gKiBAZXhhbXBsZVxuICogYGBgaHRtbFxuICogPHlhLW1hcCBbY2VudGVyXT1cIls1NS43NjE5NTIsIDM3LjYyMDczOV1cIj5cbiAqICAgPHlhLWNsdXN0ZXJlciBbb3B0aW9uc109XCJ7IG1pbkNsdXN0ZXJTaXplOiA1IH1cIj5cbiAqICAgICA8eWEtcGxhY2VtYXJrIFtnZW9tZXRyeV09XCJbNTUuNzQsIDM3LjVdXCI+PC95YS1wbGFjZW1hcms+XG4gKiAgICAgPHlhLXBsYWNlbWFyayBbZ2VvbWV0cnldPVwiWzU1LjY0LCAzNy40Nl1cIj48L3lhLXBsYWNlbWFyaz5cbiAqICAgICA8eWEtcGxhY2VtYXJrIFtnZW9tZXRyeV09XCJbNTUuNzUsIDM3LjM4XVwiPjwveWEtcGxhY2VtYXJrPlxuICpcbiAqICAgICA8eWEtZ2Vvb2JqZWN0XG4gKiAgICAgICBbZmVhdHVyZV09XCJ7IGdlb21ldHJ5OiB7IHR5cGU6ICdQb2ludCcsIGNvb3JkaW5hdGVzOiBbNTUuODEsIDM3LjRdIH0gfVwiXG4gKiAgICAgID48L3lhLWdlb29iamVjdD5cbiAqXG4gKiAgICAgPHlhLWdlb29iamVjdFxuICogICAgICAgW2ZlYXR1cmVdPVwieyBnZW9tZXRyeTogeyB0eXBlOiAnUG9pbnQnLCBjb29yZGluYXRlczogWzU1LjcsIDM3LjM5XSB9IH1cIlxuICogICAgICA+PC95YS1nZW9vYmplY3Q+XG4gKiAgIDwveWEtY2x1c3RlcmVyPlxuICogPC95YS1tYXA+XG4gKiBgYGBcbiAqL1xuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAneWEtY2x1c3RlcmVyJyxcbiAgdGVtcGxhdGU6ICc8bmctY29udGVudD48L25nLWNvbnRlbnQ+JyxcbiAgY2hhbmdlRGV0ZWN0aW9uOiBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneS5PblB1c2gsXG59KVxuZXhwb3J0IGNsYXNzIFlhQ2x1c3RlcmVyQ29tcG9uZW50IGltcGxlbWVudHMgQWZ0ZXJDb250ZW50SW5pdCwgT25DaGFuZ2VzLCBPbkRlc3Ryb3kge1xuICBAQ29udGVudENoaWxkcmVuKFlhUGxhY2VtYXJrRGlyZWN0aXZlKVxuICBwcml2YXRlIHJlYWRvbmx5IF9wbGFjZW1hcmtzOiBRdWVyeUxpc3Q8WWFQbGFjZW1hcmtEaXJlY3RpdmU+O1xuXG4gIEBDb250ZW50Q2hpbGRyZW4oWWFHZW9PYmplY3REaXJlY3RpdmUpXG4gIHByaXZhdGUgcmVhZG9ubHkgX2dlb09iamVjdHM6IFF1ZXJ5TGlzdDxZYUdlb09iamVjdERpcmVjdGl2ZT47XG5cbiAgcHJpdmF0ZSByZWFkb25seSBfc3ViID0gbmV3IFN1YnNjcmlwdGlvbigpO1xuXG4gIHByaXZhdGUgcmVhZG9ubHkgX2V2ZW50TWFuYWdlciA9IG5ldyBFdmVudE1hbmFnZXIodGhpcy5fbmdab25lKTtcblxuICBwcml2YXRlIF9jbHVzdGVyZXI/OiB5bWFwcy5DbHVzdGVyZXI7XG5cbiAgLyoqXG4gICAqIE9wdGlvbnMgZm9yIHRoZSBjbHVzdGVyZXIuXG4gICAqIHtAbGluayBodHRwczovL3lhbmRleC5jb20vZGV2L21hcHMvanNhcGkvZG9jLzIuMS9yZWYvcmVmZXJlbmNlL0NsdXN0ZXJlci5odG1sI0NsdXN0ZXJlcl9fcGFyYW0tb3B0aW9uc31cbiAgICovXG4gIEBJbnB1dCgpIG9wdGlvbnM6IHltYXBzLklDbHVzdGVyZXJPcHRpb25zO1xuXG4gIC8qKlxuICAgKiBDbHVzdGVyZXIgaW5zdGFuY2UgaXMgYWRkZWQgaW4gYSBNYXAuXG4gICAqL1xuICBAT3V0cHV0KCkgcmVhZHk6IEV2ZW50RW1pdHRlcjxZYVJlYWR5RXZlbnQ8eW1hcHMuQ2x1c3RlcmVyPj4gPSBuZXcgRXZlbnRFbWl0dGVyPFxuICAgIFlhUmVhZHlFdmVudDx5bWFwcy5DbHVzdGVyZXI+XG4gID4oKTtcblxuICAvKipcbiAgICogQ2xvc2luZyB0aGUgaGludC5cbiAgICovXG4gIEBPdXRwdXQoKSBoaW50Y2xvc2U6IE9ic2VydmFibGU8WWFFdmVudDx5bWFwcy5DbHVzdGVyZXI+PiA9XG4gICAgdGhpcy5fZXZlbnRNYW5hZ2VyLmdldExhenlFbWl0dGVyKCdoaW50Y2xvc2UnKTtcblxuICAvKipcbiAgICogT3BlbmluZyBhIGhpbnQgb24gYSBtYXAuXG4gICAqL1xuICBAT3V0cHV0KCkgaGludG9wZW46IE9ic2VydmFibGU8WWFFdmVudDx5bWFwcy5DbHVzdGVyZXI+PiA9XG4gICAgdGhpcy5fZXZlbnRNYW5hZ2VyLmdldExhenlFbWl0dGVyKCdoaW50b3BlbicpO1xuXG4gIC8qKlxuICAgKiBNYXAgcmVmZXJlbmNlIGNoYW5nZWQuXG4gICAqL1xuICBAT3V0cHV0KCkgbWFwY2hhbmdlOiBPYnNlcnZhYmxlPFlhRXZlbnQ8eW1hcHMuQ2x1c3RlcmVyPj4gPVxuICAgIHRoaXMuX2V2ZW50TWFuYWdlci5nZXRMYXp5RW1pdHRlcignbWFwY2hhbmdlJyk7XG5cbiAgLyoqXG4gICAqIENoYW5nZSB0byB0aGUgb2JqZWN0IG9wdGlvbnMuXG4gICAqL1xuICBAT3V0cHV0KCkgb3B0aW9uc2NoYW5nZTogT2JzZXJ2YWJsZTxZYUV2ZW50PHltYXBzLkNsdXN0ZXJlcj4+ID1cbiAgICB0aGlzLl9ldmVudE1hbmFnZXIuZ2V0TGF6eUVtaXR0ZXIoJ29wdGlvbnNjaGFuZ2UnKTtcblxuICAvKipcbiAgICogVGhlIHBhcmVudCBvYmplY3QgcmVmZXJlbmNlIGNoYW5nZWQuXG4gICAqL1xuICBAT3V0cHV0KCkgcGFyZW50Y2hhbmdlOiBPYnNlcnZhYmxlPFlhRXZlbnQ8eW1hcHMuQ2x1c3RlcmVyPj4gPVxuICAgIHRoaXMuX2V2ZW50TWFuYWdlci5nZXRMYXp5RW1pdHRlcigncGFyZW50Y2hhbmdlJyk7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBfbmdab25lOiBOZ1pvbmUsIHByaXZhdGUgcmVhZG9ubHkgX3lhTWFwQ29tcG9uZW50OiBZYU1hcENvbXBvbmVudCkge31cblxuICAvKipcbiAgICogSGFuZGxlcyBpbnB1dCBjaGFuZ2VzIGFuZCBwYXNzZXMgdGhlbSBpbiBBUEkuXG4gICAqIEBwYXJhbSBjaGFuZ2VzXG4gICAqL1xuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKTogdm9pZCB7XG4gICAgY29uc3QgY2x1c3RlcmVyID0gdGhpcy5fY2x1c3RlcmVyO1xuXG4gICAgaWYgKGNsdXN0ZXJlcikge1xuICAgICAgY29uc3QgeyBvcHRpb25zIH0gPSBjaGFuZ2VzO1xuXG4gICAgICBpZiAob3B0aW9ucykge1xuICAgICAgICBjbHVzdGVyZXIub3B0aW9ucy5zZXQob3B0aW9ucy5jdXJyZW50VmFsdWUpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIG5nQWZ0ZXJDb250ZW50SW5pdCgpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5feWFNYXBDb21wb25lbnQuaXNCcm93c2VyKSB7XG4gICAgICBjb25zdCBzdWIgPSB0aGlzLl95YU1hcENvbXBvbmVudC5tYXAkLnN1YnNjcmliZSgobWFwKSA9PiB7XG4gICAgICAgIGlmIChtYXApIHtcbiAgICAgICAgICBjb25zdCBjbHVzdGVyZXIgPSB0aGlzLl9jcmVhdGVDbHVzdGVyZXIoKTtcbiAgICAgICAgICB0aGlzLl9jbHVzdGVyZXIgPSBjbHVzdGVyZXI7XG5cbiAgICAgICAgICBtYXAuZ2VvT2JqZWN0cy5hZGQoY2x1c3RlcmVyKTtcbiAgICAgICAgICB0aGlzLl9ldmVudE1hbmFnZXIuc2V0VGFyZ2V0KGNsdXN0ZXJlcik7XG4gICAgICAgICAgdGhpcy5fd2F0Y2hGb3JDb250ZW50Q2hhbmdlcyhjbHVzdGVyZXIpO1xuICAgICAgICAgIHRoaXMuX25nWm9uZS5ydW4oKCkgPT4gdGhpcy5yZWFkeS5lbWl0KHsgeW1hcHMsIHRhcmdldDogY2x1c3RlcmVyIH0pKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICAgIHRoaXMuX3N1Yi5hZGQoc3ViKTtcbiAgICB9XG4gIH1cblxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICB0aGlzLl9ldmVudE1hbmFnZXIuZGVzdHJveSgpO1xuICAgIHRoaXMuX3N1Yi51bnN1YnNjcmliZSgpO1xuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZXMgQ2x1c3RlcmVyLlxuICAgKi9cbiAgcHJpdmF0ZSBfY3JlYXRlQ2x1c3RlcmVyKCk6IHltYXBzLkNsdXN0ZXJlciB7XG4gICAgcmV0dXJuIG5ldyB5bWFwcy5DbHVzdGVyZXIodGhpcy5vcHRpb25zKTtcbiAgfVxuXG4gIHByaXZhdGUgX3dhdGNoRm9yQ29udGVudENoYW5nZXMoY2x1c3RlcmVyOiB5bWFwcy5DbHVzdGVyZXIpOiB2b2lkIHtcbiAgICAvKipcbiAgICAgKiBBZGRzIG5ldyBQbGFjZW1hcmtzIHRvIHRoZSBjbHVzdGVyZXIgb24gY2hhbmdlcy5cbiAgICAgKi9cbiAgICBjb25zdCBjdXJyZW50UGxhY2VtYXJrcyA9IG5ldyBTZXQ8eW1hcHMuUGxhY2VtYXJrPigpO1xuXG4gICAgdGhpcy5fZ2V0SW50ZXJuYWxQbGFjZW1hcmtzKHRoaXMuX3BsYWNlbWFya3MudG9BcnJheSgpKS5mb3JFYWNoKChwbGFjZW1hcmspID0+IHtcbiAgICAgIGN1cnJlbnRQbGFjZW1hcmtzLmFkZChwbGFjZW1hcmspO1xuICAgICAgY2x1c3RlcmVyLmFkZChwbGFjZW1hcmspO1xuICAgIH0pO1xuXG4gICAgY29uc3QgcGxhY2VtYXJrc1N1YiA9IHRoaXMuX3BsYWNlbWFya3MuY2hhbmdlcy5zdWJzY3JpYmUoXG4gICAgICAocGxhY2VtYXJrRGlyZWN0aXZlczogWWFQbGFjZW1hcmtEaXJlY3RpdmVbXSkgPT4ge1xuICAgICAgICBjb25zdCBuZXdQbGFjZW1hcmtzID0gbmV3IFNldDx5bWFwcy5QbGFjZW1hcms+KFxuICAgICAgICAgIHRoaXMuX2dldEludGVybmFsUGxhY2VtYXJrcyhwbGFjZW1hcmtEaXJlY3RpdmVzKSxcbiAgICAgICAgKTtcblxuICAgICAgICBjb25zdCBkaWZmZXJlbmNlID0gdGhpcy5fZ2V0RGlmZmVyZW5jZTx5bWFwcy5QbGFjZW1hcms+KG5ld1BsYWNlbWFya3MsIGN1cnJlbnRQbGFjZW1hcmtzKTtcblxuICAgICAgICBjbHVzdGVyZXIuYWRkKGRpZmZlcmVuY2UudG9BZGQpO1xuICAgICAgICBjbHVzdGVyZXIucmVtb3ZlKGRpZmZlcmVuY2UudG9SZW1vdmUpO1xuICAgICAgfSxcbiAgICApO1xuXG4gICAgdGhpcy5fc3ViLmFkZChwbGFjZW1hcmtzU3ViKTtcblxuICAgIC8qKlxuICAgICAqIEFkZHMgbmV3IEdlb09iamVjdHMgdG8gdGhlIGNsdXN0ZXJlciBvbiBjaGFuZ2VzLlxuICAgICAqL1xuICAgIGNvbnN0IGN1cnJlbnRHZW9PYmplY3RzID0gbmV3IFNldDx5bWFwcy5HZW9PYmplY3Q+KCk7XG5cbiAgICB0aGlzLl9nZXRJbnRlcm5hbEdlb09iamVjdHModGhpcy5fZ2VvT2JqZWN0cy50b0FycmF5KCkpLmZvckVhY2goKGdlb09iamVjdCkgPT4ge1xuICAgICAgY3VycmVudEdlb09iamVjdHMuYWRkKGdlb09iamVjdCk7XG4gICAgICBjbHVzdGVyZXIuYWRkKGdlb09iamVjdCk7XG4gICAgfSk7XG5cbiAgICBjb25zdCBnZW9PYmplY3RzU3ViID0gdGhpcy5fZ2VvT2JqZWN0cy5jaGFuZ2VzLnN1YnNjcmliZShcbiAgICAgIChnZW9PYmplY3REaXJlY3RpdmVzOiBZYUdlb09iamVjdERpcmVjdGl2ZVtdKSA9PiB7XG4gICAgICAgIGNvbnN0IG5ld0dlb09iamVjdHMgPSBuZXcgU2V0PHltYXBzLkdlb09iamVjdD4oXG4gICAgICAgICAgdGhpcy5fZ2V0SW50ZXJuYWxHZW9PYmplY3RzKGdlb09iamVjdERpcmVjdGl2ZXMpLFxuICAgICAgICApO1xuXG4gICAgICAgIGNvbnN0IGRpZmZlcmVuY2UgPSB0aGlzLl9nZXREaWZmZXJlbmNlPHltYXBzLkdlb09iamVjdD4obmV3R2VvT2JqZWN0cywgY3VycmVudEdlb09iamVjdHMpO1xuXG4gICAgICAgIGNsdXN0ZXJlci5hZGQoZGlmZmVyZW5jZS50b0FkZCk7XG4gICAgICAgIGNsdXN0ZXJlci5yZW1vdmUoZGlmZmVyZW5jZS50b1JlbW92ZSk7XG4gICAgICB9LFxuICAgICk7XG5cbiAgICB0aGlzLl9zdWIuYWRkKGdlb09iamVjdHNTdWIpO1xuICB9XG5cbiAgLyoqXG4gICAqIERldGVybWluZXMgd2hhdCBzaG91bGQgYmUgYWRkZWQvcmVtb3ZlZCBpbiBjdXJyZW50IHNldCB0byBlcXVhbCBuZXcgc2V0XG4gICAqXG4gICAqIEBwYXJhbSBuZXdTZXRcbiAgICogQHBhcmFtIGN1cnJlbnRTZXRcbiAgICovXG4gIHByaXZhdGUgX2dldERpZmZlcmVuY2U8VD4obmV3U2V0OiBTZXQ8VD4sIGN1cnJlbnRTZXQ6IFNldDxUPikge1xuICAgIGNvbnN0IHRvQWRkOiBUW10gPSBbXTtcbiAgICBjb25zdCB0b1JlbW92ZTogVFtdID0gW107XG5cbiAgICBuZXdTZXQuZm9yRWFjaCgoY29tcG9uZW50KSA9PiB7XG4gICAgICBpZiAoIWN1cnJlbnRTZXQuaGFzKGNvbXBvbmVudCkpIHtcbiAgICAgICAgdG9BZGQucHVzaChjb21wb25lbnQpO1xuICAgICAgICBjdXJyZW50U2V0LmFkZChjb21wb25lbnQpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgY3VycmVudFNldC5mb3JFYWNoKChjb21wb25lbnQpID0+IHtcbiAgICAgIGlmICghbmV3U2V0Lmhhcyhjb21wb25lbnQpKSB7XG4gICAgICAgIHRvUmVtb3ZlLnB1c2goY29tcG9uZW50KTtcbiAgICAgICAgY3VycmVudFNldC5kZWxldGUoY29tcG9uZW50KTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHJldHVybiB7XG4gICAgICB0b0FkZCxcbiAgICAgIHRvUmVtb3ZlLFxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIF9nZXRJbnRlcm5hbFBsYWNlbWFya3MocGxhY2VtYXJrczogWWFQbGFjZW1hcmtEaXJlY3RpdmVbXSk6IHltYXBzLlBsYWNlbWFya1tdIHtcbiAgICByZXR1cm4gcGxhY2VtYXJrc1xuICAgICAgLmZpbHRlcigoY29tcG9uZW50KSA9PiAhIWNvbXBvbmVudC5wbGFjZW1hcmspXG4gICAgICAubWFwKChjb21wb25lbnQpID0+IGNvbXBvbmVudC5wbGFjZW1hcmshKTtcbiAgfVxuXG4gIHByaXZhdGUgX2dldEludGVybmFsR2VvT2JqZWN0cyhnZW9PYmplY3RzOiBZYUdlb09iamVjdERpcmVjdGl2ZVtdKTogeW1hcHMuR2VvT2JqZWN0W10ge1xuICAgIHJldHVybiBnZW9PYmplY3RzXG4gICAgICAuZmlsdGVyKChjb21wb25lbnQpID0+ICEhY29tcG9uZW50Lmdlb09iamVjdClcbiAgICAgIC5tYXAoKGNvbXBvbmVudCkgPT4gY29tcG9uZW50Lmdlb09iamVjdCEpO1xuICB9XG59XG4iXX0=