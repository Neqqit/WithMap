import { Directive, EventEmitter, Input, Output, } from '@angular/core';
import { from, Subscription } from 'rxjs';
import { filter, map, switchMap } from 'rxjs/operators';
import { EventManager } from '../../event-manager';
import * as i0 from "@angular/core";
import * as i1 from "../ya-map/ya-map.component";
/**
 * The `ya-panorama` component wraps `ymaps.panorama.Player` class from the Yandex.Maps API.
 * You can configure it via the component's inputs.
 * Events can be bound using the outputs of the component.
 *
 * <example-url>https://stackblitz.com/edit/panorama?embed=1</example-url>
 *
 * @example
 * ```html
 * <ya-map>
 *   <ya-panorama [point]="[59.938557, 30.316198]" layer="yandex#airPanorama"></ya-panorama>
 * </ya-map>
 * ```
 */
export class YaPanoramaDirective {
    constructor(_ngZone, _yaMapComponent) {
        this._ngZone = _ngZone;
        this._yaMapComponent = _yaMapComponent;
        this._sub = new Subscription();
        this._eventManager = new EventManager(this._ngZone);
        /**
         * Panorama instance is created.
         */
        this.ready = new EventEmitter();
        /**
         * The player was closed by the user or destroyed using the panorama.Player.destroy method.
         */
        this.destroy = this._eventManager.getLazyEmitter('destroy');
        /**
         * The view direction changed.
         */
        this.directionchange = this._eventManager.getLazyEmitter('directionchange');
        /**
         * An error occurred during operation of the player. The user will be shown the appropriate screen.
         */
        this.yaerror = this._eventManager.getLazyEmitter('error');
        /**
         * The panorama player switched to full-screen mode.
         */
        this.fullscreenenter = this._eventManager.getLazyEmitter('fullscreenenter');
        /**
         * The panorama player exited full-screen mode.
         */
        this.fullscreenexit = this._eventManager.getLazyEmitter('fullscreenexit');
        /**
         * The user clicked on an expanded marker.
         */
        this.markercollapse = this._eventManager.getLazyEmitter('markercollapse');
        /**
         * The user clicked on a collapsed marker.
         */
        this.markerexpand = this._eventManager.getLazyEmitter('markerexpand');
        /**
         * The user's cursor hovered over a marker.
         */
        this.markermouseenter = this._eventManager.getLazyEmitter('markermouseenter');
        /**
         * The user's cursor left a marker.
         */
        this.markermouseleave = this._eventManager.getLazyEmitter('markermouseleave');
        /**
         * The open panorama changed.
         */
        this.panoramachange = this._eventManager.getLazyEmitter('panoramachange');
        /**
         * The size of the viewport has been changed.
         */
        this.spanchange = this._eventManager.getLazyEmitter('spanchange');
    }
    /**
     * Handles input changes and passes them in API.
     * @param changes
     */
    ngOnChanges(changes) {
        const player = this._player;
        if (player) {
            const { point, layer, options } = changes;
            /**
             * player.moveTo resets values to default if any of them isn't passed.
             * That's why we use value from currentValue OR previous value from input.
             * With that logic it's possible to pass only point, layer or options.
             */
            if (point || layer) {
                const combinedPoint = point?.currentValue || this.point;
                const combinedLayer = layer?.currentValue || this.layer;
                player.moveTo(combinedPoint, { layer: combinedLayer });
            }
            if (options) {
                this._setOptions(options.currentValue, player);
            }
        }
    }
    ngOnInit() {
        if (this._yaMapComponent.isBrowser) {
            const panorama$ = this._yaMapComponent.map$.pipe(filter((m) => Boolean(m)), switchMap((m) => {
                /**
                 * Map and panorama use the same container, so need to destroy/remove map
                 */
                m.destroy();
                return this._createPanorama();
            }));
            const sub = panorama$.subscribe((panorama) => {
                const { id } = this._yaMapComponent.container.nativeElement;
                const player = new ymaps.panorama.Player(id, panorama, this.options);
                this._player = player;
                this._eventManager.setTarget(player);
                this._ngZone.run(() => this.ready.emit({ ymaps, target: player }));
            });
            this._sub.add(sub);
        }
    }
    ngOnDestroy() {
        this._eventManager.destroy();
        this._sub.unsubscribe();
    }
    /**
     * Destructs state and passes it in API.
     * @param options
     * @param player
     */
    _setOptions(options, player) {
        const { autoFitToViewport, controls, direction, hotkeysEnabled, span, scrollZoomBehavior, suppressMapOpenBlock, } = options;
        if (autoFitToViewport ||
            controls ||
            hotkeysEnabled ||
            scrollZoomBehavior ||
            suppressMapOpenBlock) {
            console.warn('Only direction and span can be set after entity init. To set other options, you should recreate a Panorama with new options');
        }
        if (direction) {
            player.setDirection(direction);
        }
        if (span) {
            player.setSpan(span);
        }
    }
    /**
     * Searches for a panorama and returns first
     */
    _createPanorama() {
        return from(ymaps.panorama.locate(this.point, { layer: this.layer })).pipe(map((panoramas) => panoramas[0]));
    }
}
YaPanoramaDirective.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.0.2", ngImport: i0, type: YaPanoramaDirective, deps: [{ token: i0.NgZone }, { token: i1.YaMapComponent }], target: i0.ɵɵFactoryTarget.Directive });
YaPanoramaDirective.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "12.0.0", version: "13.0.2", type: YaPanoramaDirective, selector: "ya-panorama", inputs: { point: "point", layer: "layer", options: "options" }, outputs: { ready: "ready", destroy: "destroy", directionchange: "directionchange", yaerror: "yaerror", fullscreenenter: "fullscreenenter", fullscreenexit: "fullscreenexit", markercollapse: "markercollapse", markerexpand: "markerexpand", markermouseenter: "markermouseenter", markermouseleave: "markermouseleave", panoramachange: "panoramachange", spanchange: "spanchange" }, usesOnChanges: true, ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.0.2", ngImport: i0, type: YaPanoramaDirective, decorators: [{
            type: Directive,
            args: [{
                    selector: 'ya-panorama',
                }]
        }], ctorParameters: function () { return [{ type: i0.NgZone }, { type: i1.YaMapComponent }]; }, propDecorators: { point: [{
                type: Input
            }], layer: [{
                type: Input
            }], options: [{
                type: Input
            }], ready: [{
                type: Output
            }], destroy: [{
                type: Output
            }], directionchange: [{
                type: Output
            }], yaerror: [{
                type: Output
            }], fullscreenenter: [{
                type: Output
            }], fullscreenexit: [{
                type: Output
            }], markercollapse: [{
                type: Output
            }], markerexpand: [{
                type: Output
            }], markermouseenter: [{
                type: Output
            }], markermouseleave: [{
                type: Output
            }], panoramachange: [{
                type: Output
            }], spanchange: [{
                type: Output
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoieWEtcGFub3JhbWEuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvYW5ndWxhcjgteWFuZGV4LW1hcHMvc3JjL2xpYi9jb21wb25lbnRzL3lhLXBhbm9yYW1hL3lhLXBhbm9yYW1hLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0wsU0FBUyxFQUNULFlBQVksRUFDWixLQUFLLEVBS0wsTUFBTSxHQUVQLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxJQUFJLEVBQWMsWUFBWSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3RELE9BQU8sRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3hELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQzs7O0FBS25EOzs7Ozs7Ozs7Ozs7O0dBYUc7QUFJSCxNQUFNLE9BQU8sbUJBQW1CO0lBa0c5QixZQUE2QixPQUFlLEVBQW1CLGVBQStCO1FBQWpFLFlBQU8sR0FBUCxPQUFPLENBQVE7UUFBbUIsb0JBQWUsR0FBZixlQUFlLENBQWdCO1FBakc3RSxTQUFJLEdBQUcsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUUxQixrQkFBYSxHQUFHLElBQUksWUFBWSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztRQXNCaEU7O1dBRUc7UUFDTyxVQUFLLEdBQXNELElBQUksWUFBWSxFQUVsRixDQUFDO1FBRUo7O1dBRUc7UUFDTyxZQUFPLEdBQ2YsSUFBSSxDQUFDLGFBQWEsQ0FBQyxjQUFjLENBQUMsU0FBUyxDQUFDLENBQUM7UUFFL0M7O1dBRUc7UUFDTyxvQkFBZSxHQUN2QixJQUFJLENBQUMsYUFBYSxDQUFDLGNBQWMsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1FBRXZEOztXQUVHO1FBQ08sWUFBTyxHQUNmLElBQUksQ0FBQyxhQUFhLENBQUMs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QUUsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FDakMsQ0FBQztJQUNKLENBQUM7O2dIQTNNVSxtQkFBbUI7b0dBQW5CLG1CQUFtQjsyRkFBbkIsbUJBQW1CO2tCQUgvQixTQUFTO21CQUFDO29CQUNULFFBQVEsRUFBRSxhQUFhO2lCQUN4QjswSEFZVSxLQUFLO3NCQUFiLEtBQUs7Z0JBTUcsS0FBSztzQkFBYixLQUFLO2dCQU1HLE9BQU87c0JBQWYsS0FBSztnQkFLSSxLQUFLO3NCQUFkLE1BQU07Z0JBT0csT0FBTztzQkFBaEIsTUFBTTtnQkFNRyxlQUFlO3NCQUF4QixNQUFNO2dCQU1HLE9BQU87c0JBQWhCLE1BQU07Z0JBTUcsZUFBZTtzQkFBeEIsTUFBTTtnQkFNRyxjQUFjO3NCQUF2QixNQUFNO2dCQU1HLGNBQWM7c0JBQXZCLE1BQU07Z0JBTUcsWUFBWTtzQkFBckIsTUFBTTtnQkFNRyxnQkFBZ0I7c0JBQXpCLE1BQU07Z0JBTUcsZ0JBQWdCO3NCQUF6QixNQUFNO2dCQU1HLGNBQWM7c0JBQXZCLE1BQU07Z0JBTUcsVUFBVTtzQkFBbkIsTUFBTSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIERpcmVjdGl2ZSxcbiAgRXZlbnRFbWl0dGVyLFxuICBJbnB1dCxcbiAgTmdab25lLFxuICBPbkNoYW5nZXMsXG4gIE9uRGVzdHJveSxcbiAgT25Jbml0LFxuICBPdXRwdXQsXG4gIFNpbXBsZUNoYW5nZXMsXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgZnJvbSwgT2JzZXJ2YWJsZSwgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBmaWx0ZXIsIG1hcCwgc3dpdGNoTWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgRXZlbnRNYW5hZ2VyIH0gZnJvbSAnLi4vLi4vZXZlbnQtbWFuYWdlcic7XG5pbXBvcnQgeyBZYU1hcENvbXBvbmVudCB9IGZyb20gJy4uL3lhLW1hcC95YS1tYXAuY29tcG9uZW50JztcbmltcG9ydCB7IFlhUmVhZHlFdmVudCB9IGZyb20gJy4uLy4uL3R5cGluZ3MveWEtcmVhZHktZXZlbnQnO1xuaW1wb3J0IHsgWWFFdmVudCB9IGZyb20gJy4uLy4uL3R5cGluZ3MveWEtZXZlbnQnO1xuXG4vKipcbiAqIFRoZSBgeWEtcGFub3JhbWFgIGNvbXBvbmVudCB3cmFwcyBgeW1hcHMucGFub3JhbWEuUGxheWVyYCBjbGFzcyBmcm9tIHRoZSBZYW5kZXguTWFwcyBBUEkuXG4gKiBZb3UgY2FuIGNvbmZpZ3VyZSBpdCB2aWEgdGhlIGNvbXBvbmVudCdzIGlucHV0cy5cbiAqIEV2ZW50cyBjYW4gYmUgYm91bmQgdXNpbmcgdGhlIG91dHB1dHMgb2YgdGhlIGNvbXBvbmVudC5cbiAqXG4gKiA8ZXhhbXBsZS11cmw+aHR0cHM6Ly9zdGFja2JsaXR6LmNvbS9lZGl0L3Bhbm9yYW1hP2VtYmVkPTE8L2V4YW1wbGUtdXJsPlxuICpcbiAqIEBleGFtcGxlXG4gKiBgYGBodG1sXG4gKiA8eWEtbWFwPlxuICogICA8eWEtcGFub3JhbWEgW3BvaW50XT1cIls1OS45Mzg1NTcsIDMwLjMxNjE5OF1cIiBsYXllcj1cInlhbmRleCNhaXJQYW5vcmFtYVwiPjwveWEtcGFub3JhbWE+XG4gKiA8L3lhLW1hcD5cbiAqIGBgYFxuICovXG5ARGlyZWN0aXZlKHtcbiAgc2VsZWN0b3I6ICd5YS1wYW5vcmFtYScsXG59KVxuZXhwb3J0IGNsYXNzIFlhUGFub3JhbWFEaXJlY3RpdmUgaW1wbGVtZW50cyBPbkluaXQsIE9uQ2hhbmdlcywgT25EZXN0cm95IHtcbiAgcHJpdmF0ZSByZWFkb25seSBfc3ViID0gbmV3IFN1YnNjcmlwdGlvbigpO1xuXG4gIHByaXZhdGUgcmVhZG9ubHkgX2V2ZW50TWFuYWdlciA9IG5ldyBFdmVudE1hbmFnZXIodGhpcy5fbmdab25lKTtcblxuICBwcml2YXRlIF9wbGF5ZXI/OiB5bWFwcy5wYW5vcmFtYS5QbGF5ZXI7XG5cbiAgLyoqXG4gICAqIFRoZSBwb2ludCBmb3Igc2VhcmNoaW5nIGZvciBuZWFyYnkgcGFub3JhbWFzLlxuICAgKiB7QGxpbmsgaHR0cHM6Ly95YW5kZXguY29tL2Rldi9tYXBzL2pzYXBpL2RvYy8yLjEvcmVmL3JlZmVyZW5jZS9wYW5vcmFtYS5sb2NhdGUuaHRtbCNwYW5vcmFtYS5sb2NhdGVfX3BhcmFtLXBvaW50fVxuICAgKi9cbiAgQElucHV0KCkgcG9pbnQ6IG51bWJlcltdO1xuXG4gIC8qKlxuICAgKiBUaGUgbGF5ZXIgdG8gc2VhcmNoIGZvciBwYW5vcmFtYXMuXG4gICAqIHtAbGluayBodHRwczovL3lhbmRleC5jb20vZGV2L21hcHMvanNhcGkvZG9jLzIuMS9yZWYvcmVmZXJlbmNlL3Bhbm9yYW1hLmxvY2F0ZS5odG1sI3Bhbm9yYW1hLmxvY2F0ZV9fcGFyYW0tb3B0aW9ucy5sYXllcn1cbiAgICovXG4gIEBJbnB1dCgpIGxheWVyOiB5bWFwcy5wYW5vcmFtYS5MYXllcjtcblxuICAvKipcbiAgICogT3B0aW9ucyBmb3IgdGhlIHBsYXllci5cbiAgICoge0BsaW5rIGh0dHBzOi8veWFuZGV4LmNvbS9kZXYvbWFwcy9qc2FwaS9kb2MvMi4xL3JlZi9yZWZlcmVuY2UvcGFub3JhbWEuUGxheWVyLmh0bWwjcGFub3JhbWEuUGxheWVyX19wYXJhbS1vcHRpb25zfVxuICAgKi9cbiAgQElucHV0KCkgb3B0aW9uczogeW1hcHMucGFub3JhbWEuSVBsYXllck9wdGlvbnM7XG5cbiAgLyoqXG4gICAqIFBhbm9yYW1hIGluc3RhbmNlIGlzIGNyZWF0ZWQuXG4gICAqL1xuICBAT3V0cHV0KCkgcmVhZHk6IEV2ZW50RW1pdHRlcjxZYVJlYWR5RXZlbnQ8eW1hcHMucGFub3JhbWEuUGxheWVyPj4gPSBuZXcgRXZlbnRFbWl0dGVyPFxuICAgIFlhUmVhZHlFdmVudDx5bWFwcy5wYW5vcmFtYS5QbGF5ZXI+XG4gID4oKTtcblxuICAvKipcbiAgICogVGhlIHBsYXllciB3YXMgY2xvc2VkIGJ5IHRoZSB1c2VyIG9yIGRlc3Ryb3llZCB1c2luZyB0aGUgcGFub3JhbWEuUGxheWVyLmRlc3Ryb3kgbWV0aG9kLlxuICAgKi9cbiAgQE91dHB1dCgpIGRlc3Ryb3k6IE9ic2VydmFibGU8WWFFdmVudDx5bWFwcy5wYW5vcmFtYS5QbGF5ZXI+PiA9XG4gICAgdGhpcy5fZXZlbnRNYW5hZ2VyLmdldExhenlFbWl0dGVyKCdkZXN0cm95Jyk7XG5cbiAgLyoqXG4gICAqIFRoZSB2aWV3IGRpcmVjdGlvbiBjaGFuZ2VkLlxuICAgKi9cbiAgQE91dHB1dCgpIGRpcmVjdGlvbmNoYW5nZTogT2JzZXJ2YWJsZTxZYUV2ZW50PHltYXBzLnBhbm9yYW1hLlBsYXllcj4+ID1cbiAgICB0aGlzLl9ldmVudE1hbmFnZXIuZ2V0TGF6eUVtaXR0ZXIoJ2RpcmVjdGlvbmNoYW5nZScpO1xuXG4gIC8qKlxuICAgKiBBbiBlcnJvciBvY2N1cnJlZCBkdXJpbmcgb3BlcmF0aW9uIG9mIHRoZSBwbGF5ZXIuIFRoZSB1c2VyIHdpbGwgYmUgc2hvd24gdGhlIGFwcHJvcHJpYXRlIHNjcmVlbi5cbiAgICovXG4gIEBPdXRwdXQoKSB5YWVycm9yOiBPYnNlcnZhYmxlPFlhRXZlbnQ8eW1hcHMucGFub3JhbWEuUGxheWVyPj4gPVxuICAgIHRoaXMuX2V2ZW50TWFuYWdlci5nZXRMYXp5RW1pdHRlcignZXJyb3InKTtcblxuICAvKipcbiAgICogVGhlIHBhbm9yYW1hIHBsYXllciBzd2l0Y2hlZCB0byBmdWxsLXNjcmVlbiBtb2RlLlxuICAgKi9cbiAgQE91dHB1dCgpIGZ1bGxzY3JlZW5lbnRlcjogT2JzZXJ2YWJsZTxZYUV2ZW50PHltYXBzLnBhbm9yYW1hLlBsYXllcj4+ID1cbiAgICB0aGlzLl9ldmVudE1hbmFnZXIuZ2V0TGF6eUVtaXR0ZXIoJ2Z1bGxzY3JlZW5lbnRlcicpO1xuXG4gIC8qKlxuICAgKiBUaGUgcGFub3JhbWEgcGxheWVyIGV4aXRlZCBmdWxsLXNjcmVlbiBtb2RlLlxuICAgKi9cbiAgQE91dHB1dCgpIGZ1bGxzY3JlZW5leGl0OiBPYnNlcnZhYmxlPFlhRXZlbnQ8eW1hcHMucGFub3JhbWEuUGxheWVyPj4gPVxuICAgIHRoaXMuX2V2ZW50TWFuYWdlci5nZXRMYXp5RW1pdHRlcignZnVsbHNjcmVlbmV4aXQnKTtcblxuICAvKipcbiAgICogVGhlIHVzZXIgY2xpY2tlZCBvbiBhbiBleHBhbmRlZCBtYXJrZXIuXG4gICAqL1xuICBAT3V0cHV0KCkgbWFya2VyY29sbGFwc2U6IE9ic2VydmFibGU8WWFFdmVudDx5bWFwcy5wYW5vcmFtYS5QbGF5ZXI+PiA9XG4gICAgdGhpcy5fZXZlbnRNYW5hZ2VyLmdldExhenlFbWl0dGVyKCdtYXJrZXJjb2xsYXBzZScpO1xuXG4gIC8qKlxuICAgKiBUaGUgdXNlciBjbGlja2VkIG9uIGEgY29sbGFwc2VkIG1hcmtlci5cbiAgICovXG4gIEBPdXRwdXQoKSBtYXJrZXJleHBhbmQ6IE9ic2VydmFibGU8WWFFdmVudDx5bWFwcy5wYW5vcmFtYS5QbGF5ZXI+PiA9XG4gICAgdGhpcy5fZXZlbnRNYW5hZ2VyLmdldExhenlFbWl0dGVyKCdtYXJrZXJleHBhbmQnKTtcblxuICAvKipcbiAgICogVGhlIHVzZXIncyBjdXJzb3IgaG92ZXJlZCBvdmVyIGEgbWFya2VyLlxuICAgKi9cbiAgQE91dHB1dCgpIG1hcmtlcm1vdXNlZW50ZXI6IE9ic2VydmFibGU8WWFFdmVudDx5bWFwcy5wYW5vcmFtYS5QbGF5ZXI+PiA9XG4gICAgdGhpcy5fZXZlbnRNYW5hZ2VyLmdldExhenlFbWl0dGVyKCdtYXJrZXJtb3VzZWVudGVyJyk7XG5cbiAgLyoqXG4gICAqIFRoZSB1c2VyJ3MgY3Vyc29yIGxlZnQgYSBtYXJrZXIuXG4gICAqL1xuICBAT3V0cHV0KCkgbWFya2VybW91c2VsZWF2ZTogT2JzZXJ2YWJsZTxZYUV2ZW50PHltYXBzLnBhbm9yYW1hLlBsYXllcj4+ID1cbiAgICB0aGlzLl9ldmVudE1hbmFnZXIuZ2V0TGF6eUVtaXR0ZXIoJ21hcmtlcm1vdXNlbGVhdmUnKTtcblxuICAvKipcbiAgICogVGhlIG9wZW4gcGFub3JhbWEgY2hhbmdlZC5cbiAgICovXG4gIEBPdXRwdXQoKSBwYW5vcmFtYWNoYW5nZTogT2JzZXJ2YWJsZTxZYUV2ZW50PHltYXBzLnBhbm9yYW1hLlBsYXllcj4+ID1cbiAgICB0aGlzLl9ldmVudE1hbmFnZXIuZ2V0TGF6eUVtaXR0ZXIoJ3Bhbm9yYW1hY2hhbmdlJyk7XG5cbiAgLyoqXG4gICAqIFRoZSBzaXplIG9mIHRoZSB2aWV3cG9ydCBoYXMgYmVlbiBjaGFuZ2VkLlxuICAgKi9cbiAgQE91dHB1dCgpIHNwYW5jaGFuZ2U6IE9ic2VydmFibGU8WWFFdmVudDx5bWFwcy5wYW5vcmFtYS5QbGF5ZXI+PiA9XG4gICAgdGhpcy5fZXZlbnRNYW5hZ2VyLmdldExhenlFbWl0dGVyKCdzcGFuY2hhbmdlJyk7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBfbmdab25lOiBOZ1pvbmUsIHByaXZhdGUgcmVhZG9ubHkgX3lhTWFwQ29tcG9uZW50OiBZYU1hcENvbXBvbmVudCkge31cblxuICAvKipcbiAgICogSGFuZGxlcyBpbnB1dCBjaGFuZ2VzIGFuZCBwYXNzZXMgdGhlbSBpbiBBUEkuXG4gICAqIEBwYXJhbSBjaGFuZ2VzXG4gICAqL1xuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKTogdm9pZCB7XG4gICAgY29uc3QgcGxheWVyID0gdGhpcy5fcGxheWVyO1xuXG4gICAgaWYgKHBsYXllcikge1xuICAgICAgY29uc3QgeyBwb2ludCwgbGF5ZXIsIG9wdGlvbnMgfSA9IGNoYW5nZXM7XG5cbiAgICAgIC8qKlxuICAgICAgICogcGxheWVyLm1vdmVUbyByZXNldHMgdmFsdWVzIHRvIGRlZmF1bHQgaWYgYW55IG9mIHRoZW0gaXNuJ3QgcGFzc2VkLlxuICAgICAgICogVGhhdCdzIHdoeSB3ZSB1c2UgdmFsdWUgZnJvbSBjdXJyZW50VmFsdWUgT1IgcHJldmlvdXMgdmFsdWUgZnJvbSBpbnB1dC5cbiAgICAgICAqIFdpdGggdGhhdCBsb2dpYyBpdCdzIHBvc3NpYmxlIHRvIHBhc3Mgb25seSBwb2ludCwgbGF5ZXIgb3Igb3B0aW9ucy5cbiAgICAgICAqL1xuICAgICAgaWYgKHBvaW50IHx8IGxheWVyKSB7XG4gICAgICAgIGNvbnN0IGNvbWJpbmVkUG9pbnQ6IG51bWJlcltdID0gcG9pbnQ/LmN1cnJlbnRWYWx1ZSB8fCB0aGlzLnBvaW50O1xuICAgICAgICBjb25zdCBjb21iaW5lZExheWVyOiB5bWFwcy5wYW5vcmFtYS5MYXllciA9IGxheWVyPy5jdXJyZW50VmFsdWUgfHwgdGhpcy5sYXllcjtcblxuICAgICAgICBwbGF5ZXIubW92ZVRvKGNvbWJpbmVkUG9pbnQsIHsgbGF5ZXI6IGNvbWJpbmVkTGF5ZXIgfSk7XG4gICAgICB9XG5cbiAgICAgIGlmIChvcHRpb25zKSB7XG4gICAgICAgIHRoaXMuX3NldE9wdGlvbnMob3B0aW9ucy5jdXJyZW50VmFsdWUsIHBsYXllcik7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgbmdPbkluaXQoKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuX3lhTWFwQ29tcG9uZW50LmlzQnJvd3Nlcikge1xuICAgICAgY29uc3QgcGFub3JhbWEkID0gdGhpcy5feWFNYXBDb21wb25lbnQubWFwJC5waXBlKFxuICAgICAgICBmaWx0ZXIoKG0pOiBtIGlzIHltYXBzLk1hcCA9PiBCb29sZWFuKG0pKSxcbiAgICAgICAgc3dpdGNoTWFwKChtOiB5bWFwcy5NYXApID0+IHtcbiAgICAgICAgICAvKipcbiAgICAgICAgICAgKiBNYXAgYW5kIHBhbm9yYW1hIHVzZSB0aGUgc2FtZSBjb250YWluZXIsIHNvIG5lZWQgdG8gZGVzdHJveS9yZW1vdmUgbWFwXG4gICAgICAgICAgICovXG4gICAgICAgICAgbS5kZXN0cm95KCk7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuX2NyZWF0ZVBhbm9yYW1hKCk7XG4gICAgICAgIH0pLFxuICAgICAgKTtcblxuICAgICAgY29uc3Qgc3ViID0gcGFub3JhbWEkLnN1YnNjcmliZSgocGFub3JhbWEpID0+IHtcbiAgICAgICAgY29uc3QgeyBpZCB9ID0gdGhpcy5feWFNYXBDb21wb25lbnQuY29udGFpbmVyLm5hdGl2ZUVsZW1lbnQ7XG4gICAgICAgIGNvbnN0IHBsYXllciA9IG5ldyB5bWFwcy5wYW5vcmFtYS5QbGF5ZXIoaWQsIHBhbm9yYW1hLCB0aGlzLm9wdGlvbnMpO1xuICAgICAgICB0aGlzLl9wbGF5ZXIgPSBwbGF5ZXI7XG5cbiAgICAgICAgdGhpcy5fZXZlbnRNYW5hZ2VyLnNldFRhcmdldChwbGF5ZXIpO1xuICAgICAgICB0aGlzLl9uZ1pvbmUucnVuKCgpID0+IHRoaXMucmVhZHkuZW1pdCh7IHltYXBzLCB0YXJnZXQ6IHBsYXllciB9KSk7XG4gICAgICB9KTtcblxuICAgICAgdGhpcy5fc3ViLmFkZChzdWIpO1xuICAgIH1cbiAgfVxuXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgIHRoaXMuX2V2ZW50TWFuYWdlci5kZXN0cm95KCk7XG4gICAgdGhpcy5fc3ViLnVuc3Vic2NyaWJlKCk7XG4gIH1cblxuICAvKipcbiAgICogRGVzdHJ1Y3RzIHN0YXRlIGFuZCBwYXNzZXMgaXQgaW4gQVBJLlxuICAgKiBAcGFyYW0gb3B0aW9uc1xuICAgKiBAcGFyYW0gcGxheWVyXG4gICAqL1xuICBwcml2YXRlIF9zZXRPcHRpb25zKG9wdGlvbnM6IHltYXBzLnBhbm9yYW1hLklQbGF5ZXJPcHRpb25zLCBwbGF5ZXI6IHltYXBzLnBhbm9yYW1hLlBsYXllcik6IHZvaWQge1xuICAgIGNvbnN0IHtcbiAgICAgIGF1dG9GaXRUb1ZpZXdwb3J0LFxuICAgICAgY29udHJvbHMsXG4gICAgICBkaXJlY3Rpb24sXG4gICAgICBob3RrZXlzRW5hYmxlZCxcbiAgICAgIHNwYW4sXG4gICAgICBzY3JvbGxab29tQmVoYXZpb3IsXG4gICAgICBzdXBwcmVzc01hcE9wZW5CbG9jayxcbiAgICB9ID0gb3B0aW9ucztcblxuICAgIGlmIChcbiAgICAgIGF1dG9GaXRUb1ZpZXdwb3J0IHx8XG4gICAgICBjb250cm9scyB8fFxuICAgICAgaG90a2V5c0VuYWJsZWQgfHxcbiAgICAgIHNjcm9sbFpvb21CZWhhdmlvciB8fFxuICAgICAgc3VwcHJlc3NNYXBPcGVuQmxvY2tcbiAgICApIHtcbiAgICAgIGNvbnNvbGUud2FybihcbiAgICAgICAgJ09ubHkgZGlyZWN0aW9uIGFuZCBzcGFuIGNhbiBiZSBzZXQgYWZ0ZXIgZW50aXR5IGluaXQuIFRvIHNldCBvdGhlciBvcHRpb25zLCB5b3Ugc2hvdWxkIHJlY3JlYXRlIGEgUGFub3JhbWEgd2l0aCBuZXcgb3B0aW9ucycsXG4gICAgICApO1xuICAgIH1cblxuICAgIGlmIChkaXJlY3Rpb24pIHtcbiAgICAgIHBsYXllci5zZXREaXJlY3Rpb24oZGlyZWN0aW9uKTtcbiAgICB9XG5cbiAgICBpZiAoc3Bhbikge1xuICAgICAgcGxheWVyLnNldFNwYW4oc3Bhbik7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFNlYXJjaGVzIGZvciBhIHBhbm9yYW1hIGFuZCByZXR1cm5zIGZpcnN0XG4gICAqL1xuICBwcml2YXRlIF9jcmVhdGVQYW5vcmFtYSgpOiBPYnNlcnZhYmxlPHltYXBzLklQYW5vcmFtYT4ge1xuICAgIHJldHVybiBmcm9tKHltYXBzLnBhbm9yYW1hLmxvY2F0ZSh0aGlzLnBvaW50LCB7IGxheWVyOiB0aGlzLmxheWVyIH0pKS5waXBlKFxuICAgICAgbWFwKChwYW5vcmFtYXMpID0+IHBhbm9yYW1hc1swXSksXG4gICAgKTtcbiAgfVxufVxuIl19